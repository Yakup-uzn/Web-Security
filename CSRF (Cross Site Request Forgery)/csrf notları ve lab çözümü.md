<h1 align="center">IDOR (Insecure Direct Object Reference)</h1>

- **CSRF** zafiyeti bir saldırganın bir kullanıcıyı kandırarak bir linki açmasını, bir butona tıklamasını veya bir bağlantıya tıklamasını sağlamak suretiyle,
  kullanıcının hesabı üzerinde istemeden değişiklik yapmasına veya işlem gerçekleştirmesine olanak tanıyan bir güvenlik açığıdır.
  Bu zafiyet, herhangi bir web uygulamasında oturum açmış bir kullanıcının oturumunu, saldırganın o kullanıcıymış gibi işlemler yapmasına olanak sağlar.
  CSRF açıkları genellikle GET istekleri ve oturum yönetimi işlemlerinin doğru şekilde kontrol edilmemesinden kaynaklanır.
  Bu durum, saldırganın kullanıcı adına istek göndermesine ve yetkisiz işlemler yapmasına imkan tanır.
  Portswigger labları üzerinden konuyu işleyelim


  **Lab 1: CSRF vulnerability with no defenses :**
- Lab da bize bir kullanıcı hesabı vermiş.Bizde o kullanıcı hesabı ile uygulamamıza giriş yapıyoruz.
   Giriş yaptıktan sonra maili csrf zafiyetini kullanarak değiştirmemizi istiyor. 
  
  ![](https://github.com/Yakup-uzn/Web-Security/blob/6cda870572837bc0318086e69665714018c3831c/Resimler/1.png)

- Hesaba giriş yaptık ve mailimizi değiştirmek için bir istek yolladık.Bu isteğimize bakalım.

  ![](https://github.com/Yakup-uzn/Web-Security/blob/6cda870572837bc0318086e69665714018c3831c/Resimler/2.png)

- Şimdi bizim bir HTML scripti oluşturmamız gerekiyor.Bu requeste sağ tıklayıp “engagement tool” seçeneğinin üstüne gelip oradan “Generate CSRF PoC” seçeneğini seçiyoruz.Bu bize burpsuite tarafından otomatik html scripti oluşturur.

- **HTML scriptleri oluşturmamızın sebebi**, tarayıcıların kullanıcı farkında olmadan saldırganın belirlediği istekleri gönderebilmesidir. Bu scriptler, kullanıcı oturumu açıkken otomatik olarak çerezleri de göndererek, saldırganın hedef site üzerinde kullanıcı adına işlem yapmasını sağlar. Örneğin, bir img etiketiyle bir GET isteği gönderilip kullanıcının hesabı üzerinde yetkisiz değişiklikler yapılabilir.

```html
<!-- CSRF PoC - generated by Burp Suite Professional -->
<body>
<script>history.pushState('', '', '/')</script>
<form action="https://0a9306f0420ee2cc18f4a7300990028.web-security-academy.net/my-account/change-email" method="POST">
  <input type="hidden" name="email" value="joe1&#64;gmail&#46;com" />
  <input type="submit" value="Submit request" />
</form>
<script>
  document.forms[0].submit();
</script>
</body>

```

- <form> etiketi, bir HTML formu oluşturur. Bu form, bir POST isteği gönderir ve hedef URL, saldırganın değiştirmek istediği e-posta adresini içeren hedef siteye yönlendirilir.action özelliği,formun gönderileceği URL'yi belirtir.method="POST" özelliği, formun POST isteği ile gönderileceğini belirtir.

- **<input type="submit" value="Submit request"** etiketi, formun gönderilmesi için bir buton oluşturur.
  
- **<script>document.forms[0].submit();</script>** kodu, sayfa yüklendiğinde formun otomatik olarak gönderilmesini sağlar. Bu şekilde, kullanıcı herhangi bir işlem yapmadan form gönderilir.

- Bu kod, kurbanın tarayıcısında çalıştırıldığında, kullanıcının bilgisi ve onayı olmadan belirlenen e-posta adresine POST isteği gönderir. Bu, saldırganın kullanıcı adına yetkisiz değişiklikler yapmasına olanak tanır.

  ![](https://github.com/Yakup-uzn/Web-Security/blob/6cda870572837bc0318086e69665714018c3831c/Resimler/3.png)

- Son adım olarak sayfanın en üstünde bulunan "go to exploit server" butonuna tıklıyoruz.Oluşturduğumuz scripti body kısmına yapıştırıyoruz. “store” butonuna tıklayarak kaydediyoruz ve  daha sonra “deliver exploit to victim” butonu ile kurbana göndererek lab’ın çözümünü sağlıyoruz.

# CSRF tokenı nedir?
 - bir web uygulamasının kullanıcının her bir oturumunda veya form gönderiminde oluşturduğu, benzersiz ve rastgele bir değer taşıyan bir token'dır.
Bu token, her form gönderimi sırasında sunucuya gönderilir ve sunucu bu token'ı doğrular. Bu sayede, formun gerçekten kullanıcı tarafından gönderilip gönderilmediği kontrol edilir.
E-mail değiştirme için bir form oluşturalım.

```html
    <form action="" method="POST">
        <label for="email">Yeni Email:</label>
        <input type="email" id="email" name="email" required>
        <input type="hidden" name="csrf_token" value="<?php echo $_SESSION['csrf_token']; ?>">
        <input type="submit" value="Değiştir">
    </form>
```
- **<input type="hidden" name="csrf_token" value="<?php echo $_SESSION['csrf_token']; ?>"**: CSRF token'ını gizli bir alan olarak formda ekler. Bu token, form gönderildiğinde sunucuya gönderilir ve doğrulama için kullanılır.Aşşagıdaki işlemler gerçekleşir.

```php
<?php
session_start();

// CSRF token oluşturma
if (empty($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}

// Form gönderildiğinde işlemler
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // CSRF token doğrulama
    if ($_POST['csrf_token'] !== $_SESSION['csrf_token']) {
        die("CSRF doğrulaması başarısız oldu.");
    }

    // Email değiştirme işlemleri
    $new_email = filter_var($_POST['email'], FILTER_VALIDATE_EMAIL);
    if ($new_email) {
        echo "Email değiştirildi: " . htmlspecialchars($new_email);
    } else {
        echo "Geçersiz email adresi.";
    }

    // Token'ı yenile
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}
?>
```
- Eğer oturumda ($_SESSION['csrf_token']) bir token yoksa, yeni bir token oluşturulur.

***Form Gönderildiğinde İşlemler:***

- Form gönderildiğinde (POST isteği), gönderilen CSRF token oturumdaki token ile karşılaştırılır.
Token geçerli değilse, işlem durdurulur ve bir hata mesajı gösterilir.

- Token geçerli ise, email doğrulaması yapılır ve geçerli ise email değiştirilir.Kullanılan token yenilenir.

- **Token yenileme**, her form gönderiminden sonra yeni bir token oluşturulmasını sağlar. Bu, token'ın ele geçirilmesi durumunda bile saldırganın aynı token'ı kullanarak başka bir form gönderememesini garantiler.

## HTTP Yöntemlerinin Güvenlik Önlemleri

#### POST İsteklerinde CSRF Token Kullanımı:
- POST isteklerinde CSRF token'ları kullanarak, sunucu gelen isteğin geçerliliğini doğrular. Bu, yetkisiz isteklerin önlenmesine yardımcı olur.

#### GET İsteklerinde Yan Etkileri Azaltma:
- GET isteklerinin sadece veri alma işlemleri için kullanılması önerilir. Veriyi değiştiren, oluşturan veya silen işlemler için POST kullanılması gerekir. Bu, GET isteklerinin kötüye kullanılmasını engeller.

#### Diğer HTTP Yöntemleri (PUT, DELETE, PATCH):
- Bu yöntemler de veri değişikliği yapar ve benzer şekilde CSRF saldırılarına karşı korunmalıdır. Genellikle bu yöntemler de CSRF token ile korunur.

## SameSite Cookie 
- SameSite, bir web sitesinin çerezlerinin diğer web sitelerinden gelen isteklere ne zaman dahil edileceğini belirleyen bir tarayıcı güvenlik mekanizmasıdır. Bu öznitelik, çerezlerin güvenliğini artırarak CSRF (Cross-Site Request Forgery) ve bilgi sızdırma gibi güvenlik açıklarını azaltmayı amaçlar.
  

  
